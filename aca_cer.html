<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Academic Certificate Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="b.png">

<style>
  body {
    font-family: Roboto, Georgia, sans-serif;
    background: #eef2f7;
    padding: 20px;
    color: #222;
  }

  .container {
    max-width: 1300px;
    margin: auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    overflow: hidden;
    padding: 20px;
  }

  header {
    background: #0f3b63;
    color: #fff;
    padding: 20px;
    text-align: center;
    border-radius: 10px;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
    font-family: 'Playfair Display', serif;
  }

  .content { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
  .top-form { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
  .card { background: #fafcff; padding: 15px; border: 1px solid #dde5ee; border-radius: 10px; min-width: 300px; flex: 1; }
  .card label { display: block; margin: 8px 0 4px; font-weight: 500; color: #0f3b63; }
  .card input { width: 100%; padding: 8px; border: 1px solid #c8d4e2; border-radius: 6px; }
  .bottom-preview { text-align: center; margin-top: 20px; }
  .print-btn { background: #0f3b63; color: #fff; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 15px; }
  .print-btn:hover { background: #124a7a; }
  #certificatesContainer { display: flex; flex-direction: column; align-items: center; gap: 30px; }

  
  .certificate {
    width: 297mm;
    height: 210mm;
    background: #fff;
    border: 1px solid #bbb;
    padding: 20mm;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    position: relative;
    page-break-after: always;
  }

.certificate {
  width: 297mm;       
  height: 210mm;      
  padding: 10mm;      
  border: 10px solid #003366; 
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  position: relative;
  page-break-after: always;
  box-sizing: border-box; 
}



.cert-divider {
  border: 0;
  height: 3px;
  background: #0f3b63;   
  width: 50%;            
  margin: 5px auto 5px; 
}




  .student-photo { width: 100px; height: 120px; object-fit: cover; border: 2px solid #0000ff; position: absolute; top: 125px; right: 130px; }
  .school-logo { width: 120px; height: 120px; object-fit: contain; position: absolute; top: 125px; left: 120px; }

  .school-title { text-align: center; font-size: 40px; font-family: 'Playfair Display', serif; color: #b02a2a; margin-bottom: 6px; letter-spacing: 0.5px; }
  .school-addr { text-align: center; font-size: 18px; font-family: Roboto, Arial, sans-serif; color: #333; font-weight: 500; }
  .school-estd { text-align: center; font-size: 16px; font-family: monospace; color: #1a3d7c; margin-top: 2px; }
  .school-reg { text-align: center; font-size: 15px; font-family: 'Playfair Display', serif; color: #444; letter-spacing: 0.3px; margin-top: 2px; }

  .cert-heading { text-align: center; font-size: 35px; font-family: 'Playfair Display', serif; color: #0f3b63; margin: 20px 0; }
  .cert-body { font-size: 22px; color: #222; line-height: 1.6; margin-top: 20px; text-align: justify; font-family: Roboto, sans-serif; }

 
  .cert-body strong { font-family: Georgia, serif; color: #b02a2a; }


  .cert-body .wish { font-style: italic; font-family: Georgia, serif; color: #000; margin-top: 12px; display: block; }


  .signature-row { display: flex; justify-content: space-between; margin-top: 30px; align-items: flex-end; }
  .signature { text-align: center; font-weight: 600; font-size: 18px; color: #0f3b63; width: 30%; }
  .signature img { max-height: 60px; display: block; margin: auto; margin-bottom: 1px; }
  .date-issue { margin-top: 5px; font-size: 16px; font-weight: 600; color: #0f3b63; }


  .student-info-table-container { margin-left: 0; margin-right: 0; margin-top: 10px; }
  .student-info-table {
    width: 50%;
    border-collapse: collapse;
    font-size: 18px;
    font-family: 'Playfair Display', serif;
    color: #990000;
    text-align: left;
  }
  .student-info-table th,
  .student-info-table td { border: 2px solid #003366; padding: 6px; }



  @media print {
    body { background: #fff; }
    .container, .top-form, .card, header, .bottom-preview > button { display: none !important; }
    #certificatesContainer { display: block; }
    .certificate { box-shadow: none; border: 1px solid #000; margin: 0 auto; }
    @page { size: A4 landscape; margin: 10mm; }
  }


</style>
</head>
<body>

<div class="container">
  <header><h1>Certificate Generator</h1></header>
  <div class="content">
    <div class="top-form">
      <!-- School Info -->
      <div class="card">
        <label>School Name</label><input id="schoolName" placeholder="School Name">
        <label>Regd No. (School)</label><input id="schoolReg" placeholder="Regd No.">
        <label>Address (School)</label><input id="schoolAddr" placeholder="Address">
        <label>ESTD (School)</label><input id="schoolEstd" placeholder="ESTD">
        <label>Date of Issue</label><input id="dateIssue" placeholder="e.g. 2080/05/19">
      </div>

      
      <div class="card">
        <label>Upload School Logo</label><input type="file" id="logoInput" accept="image/*">
        <label>Upload Principal Sign</label><input type="file" id="principalSignInput" accept="image/*">
        <label>Upload Approved By Sign</label><input type="file" id="approveSignInput" accept="image/*">
        <label>Upload School Seal</label><input type="file" id="sealInput" accept="image/*">
      </div>

      

      <div class="card">
        <label>Upload Excel</label><input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <p style="font-size:12px;color:#666">
          Excel ‡§Æ‡§æ <b>Photo</b> column ‡§Æ‡§æ Exact filename ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç I</b>
        </p>
        <label>Upload Student Photo Folder</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
      </div>
    </div>

<button id="downloadTemplate" class="print-btn">‚¨á Download Excel Template</button>
</div>
    <div class="bottom-preview">
      <button class="print-btn" onclick="window.print()">üñ® Print Certificates</button>
      <div id="certificatesContainer"></div>
    </div>
  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
  const fileInput=document.getElementById('fileInput');
  const certContainer=document.getElementById('certificatesContainer');
  const inputs=['schoolName','schoolReg','schoolAddr','schoolEstd','dateIssue'];
  const logoInput=document.getElementById('logoInput');
  const principalSignInput=document.getElementById('principalSignInput');
  const approveSignInput=document.getElementById('approveSignInput');
  const sealInput=document.getElementById('sealInput');
  const photoFolderInput=document.getElementById('photoFolder');

  let students=JSON.parse(localStorage.getItem('students')||'[]');

  // Photos persisted as a map: normalized name -> dataURL
  // normalized name = lowercase, with extension (we‚Äôll also try without extension while matching)
  let photosMap = JSON.parse(localStorage.getItem('photosMap')||'{}');

  let schoolLogo=localStorage.getItem('schoolLogo')||'';
  let principalSign=localStorage.getItem('principalSign')||'';
  let approveSign=localStorage.getItem('approveSign')||'';
  let schoolSeal=localStorage.getItem('schoolSeal')||'';

  // Restore inputs
  inputs.forEach(id=>{
    const el=document.getElementById(id);
    el.value=localStorage.getItem(id)||'';
    el.addEventListener('input',()=>{localStorage.setItem(id,el.value);renderAll();});
  });

  // Helper: read file to base64
  function toBase64(file){ 
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsDataURL(file);
    });
  }

  // Image uploads (logo/sign/seal) -> localStorage
  async function handleSingleImage(inputEl, key){
    const f=inputEl.files && inputEl.files[0];
    if(!f) return;
    const data=await toBase64(f);
    localStorage.setItem(key, data);
    if(key==='schoolLogo') schoolLogo=data;
    if(key==='principalSign') principalSign=data;
    if(key==='approveSign') approveSign=data;
    if(key==='schoolSeal') schoolSeal=data;
    renderAll();
  }
  logoInput.addEventListener('change',()=>handleSingleImage(logoInput,'schoolLogo'));
  principalSignInput.addEventListener('change',()=>handleSingleImage(principalSignInput,'principalSign'));
  approveSignInput.addEventListener('change',()=>handleSingleImage(approveSignInput,'approveSign'));
  sealInput.addEventListener('change',()=>handleSingleImage(sealInput,'schoolSeal'));

  // Excel Upload
  fileInput.addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      students=XLSX.utils.sheet_to_json(ws,{defval:''});
      localStorage.setItem('students',JSON.stringify(students));
      renderAll();
    };
    reader.readAsArrayBuffer(f);
  });


document.getElementById('downloadTemplate').addEventListener('click',()=>{
  const wb = XLSX.utils.book_new();
  const wsData = [
    ["Name","Father Name","Mother Name","Address","Program","GPA","Completion Year","DOB","Photo","Opt. I","Opt. II","Reg. No","Symbol No"]
  ];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "Certificate_Template.xlsx");
});





  // Photo folder -> persist all to localStorage (photosMap)
  photoFolderInput.addEventListener('change', async (e)=>{
    const files=[...e.target.files];
    // Limit guard (optional): skip files > ~3MB to avoid localStorage overflow
    for(const f of files){
      try{
        const data=await toBase64(f);
        const name=f.name.toLowerCase();
        photosMap[name]=data; // key with extension
        // also save a no-extension alias for easier matching
        const noext=name.replace(/\.(jpg|jpeg|png|webp)$/,'');
        photosMap[noext]=data;
      }catch(err){ console.warn('Failed to read', f.name, err); }
    }
    localStorage.setItem('photosMap', JSON.stringify(photosMap));
    renderAll();
  });

  // Find photo by Excel "Photo" cell (with/without extension)
  function resolvePhoto(photoCellValue){
    if(!photoCellValue) return '';
    const key = (photoCellValue||'').trim().toLowerCase();
    // exact match
    if(photosMap[key]) return photosMap[key];
    // try with common extensions
    const tryExt = [key+'.jpg', key+'.jpeg', key+'.png', key+'.webp'];
    for(const k of tryExt){ if(photosMap[k]) return photosMap[k]; }
    // also if Excel provided with extension but we stored noext
    const noext = key.replace(/\.(jpg|jpeg|png|webp)$/,'');
    if(photosMap[noext]) return photosMap[noext];
    return '';
  }

  // Render
  function renderAll(){
    certContainer.innerHTML='';
    students.forEach(s=>{
      const photoUrl = resolvePhoto(s['Photo']);

      // Header fields with per-student overrides from Excel (optional)
      const schoolName = document.getElementById('schoolName').value || 'SCHOOL NAME';
      const schoolAddr = (s['School Address'] || document.getElementById('schoolAddr').value || '-');
      const schoolEstd = (s['ESTD (School)'] || document.getElementById('schoolEstd').value || '-');
      const schoolRegNo = (s['School Regd No'] || document.getElementById('schoolReg').value || '-');

      const div=document.createElement('div');
      div.className='certificate';
      div.innerHTML=`
        ${schoolLogo?`<img src="${schoolLogo}" class="school-logo" alt="logo">`:''}
        ${photoUrl?`<img src="${photoUrl}" class="student-photo" alt="photo">`:''}

        <div class="school-title">${schoolName}</div>
        <div class="school-addr">${schoolAddr}</div>
        <div class="school-estd">ESTD: ${schoolEstd}</div>
        <div class="school-reg">Regd No. ${schoolRegNo}</div>

<div class="cert-heading">Transfer/Character Certificate</div>
<hr class="cert-divider">
<div class="cert-body">
 
      Certified that <strong style="color:#b02a2a">${s['Name']||'-'}</strong> son/daughter of
          <strong style="color:#b02a2a">${s['Father Name']||'-'} & ${s['Mother Name']||'-'}</strong>,
          inhabitant of <strong style="color:#b02a2a">${s['Address']||'-'}</strong>, was a bona fide student of this school.
          He/She has duly completed <strong style="color:#b02a2a">${s['Program']||'-'}</strong> Conducted by the National Examination Board Nepal
          with GPA <strong style="color:#b02a2a">${s['GPA']||'-'}</strong> in the year <strong style="color:#b02a2a">${s['Completion Year']||'-'} BS</strong>.
          He/She bore a good moral character while at this school. His/Her Date of Birth according to the school record is
          <strong style="color:#b02a2a">${s['DOB']||'-'}</strong>.
<br><br>
<span style="font-style: italic; font-family: 'Georgia', serif; color: #000;">
  I wish him/her every success and bright future in the days to come.
</span>


   <div class="student-info-table-container">
  <table class="student-info-table">
    <tr>
      <th>Opt I</th>
      <td>${s['Opt. I']||'-'}</td>
      <th>Regd No.</th>
      <td>${s['Reg. No']||'-'}</td>
    </tr>
    <tr>
      <th>Opt II</th>
      <td>${s['Opt. II']||'-'}</td>
      <th>Symbol No</th>
      <td>${s['Symbol No']||'-'}</td>
    </tr>
  </table>
</div>



        <div class="signature-row">
          <div class="signature">${approveSign?`<img src="${approveSign}" alt="approve">`:''} Approved by</div>
         <div class="signature">${schoolSeal?`<img src="${schoolSeal}" alt="seal">`:''} School Seal</div>
          <div class="signature">${principalSign?`<img src="${principalSign}" alt="principal">`:''} Principal</div>
        </div></div>
        <div class="date-issue">Date of Issue: ${document.getElementById('dateIssue').value||'-'}</div>
      `;
      certContainer.appendChild(div);
    });
  }

  // Initial render on load
  renderAll();
</script>
</body>
</html>
